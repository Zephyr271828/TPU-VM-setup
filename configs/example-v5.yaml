job:
  name: test-v4

tpu:
  allocation_mode: "queued-resources"    # tpu-vm | queued-resources
  accelerator: v5litepod-16
  name: yufeng-${tpu.accelerator}
  zone: europe-west4-b
  version: v2-alpha-tpuv5
  pricing: spot                   
  # spot | ondemand | preemptible
  startup_script: null
  tags: ["jobman", "experiment"]
  metadata:
    owner: "yufeng"
    # owner can be used to map tpus to user I think
    purpose: "testing jobman"

setup:
  modules:
    - gcsfuse
    - docker
    - ssh
    - command

gcsfuse:
  bucket_name: llm_pruning_us_east1_d
  mount_path: /home/zephyr/gcs-bucket

ssh:
  tpu_private_key: /u/yx1168/.ssh/id_rsa
  tpu_public_key: /u/yx1168/.ssh/id_rsa.pub

docker:
  image: yx3038/maxtext_base_image:latest
  mount_dirs:
    - /home/zephyr
    - /dev
    - /run
  workdir: /home/zephyr
  flags: ["--privileged", "--network=host"]

conda:
  env_name: maxtext
  python: "3.9"
  requirements: requirements.txt

venv:
  path: /home/zephyr/venvs/maxtext

command:
  run: |
    rm -rf /home/zephyr/maxtext
    cp -r /home/zephyr/gcs-bucket/maxtext /home/zephyr/maxtext
    mkdir -p /home/zephyr/maxtext/logs

    gcloud config set project vision-mix
    gcloud config set compute/zone ${tpu.zone}
    export TPU_PREFIX=${tpu.name}
    export BUCKET_NAME=${gcsfuse.bucket_name}
    cd /home/zephyr/maxtext
    bash scripts/finetune_llama3.1_4b_width_200B.sh
  workers: [0] # int | list | "all"